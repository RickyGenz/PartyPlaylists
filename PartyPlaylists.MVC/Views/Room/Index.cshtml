@model RoomVM
@{
    ViewData["Title"] = "Index";
}

<input type="hidden" id="jwtToken" name="jwtToken" value="@Model.JwtToken">
<input type="hidden" id="roomId" name="roomId" value="@Model.CurrentRoom.Id">
<input type="hidden" id="spotifyAuthCode" name="spotifyAuthCode" value="@Model.CurrentRoom.SpotifyAuthCode" />

<h1 id="roomNameHeader">@Model.CurrentRoom.Name</h1>
<h2>By: @Model.CurrentRoom.Owner</h2>
<table class="table">
    @if (Model?.CurrentRoom != null && !string.IsNullOrEmpty(Model?.CurrentRoom?.SpotifyAuthCode))
    {
        <tr>
            <th scope="col">Artist</th>
            <th scope="col">Title</th>
            <th scope="col">Playlist Rating</th>
            <th scope="col">Added By</th>
            <th scope="col">Add Vote</th>
        </tr>
        <tbody id="tableOfSongs">
            <partial name="Components/_roomSongTableRow" model="Model.CurrentRoom.RoomSongs" />
        </tbody>
    }
</table>

@if (string.IsNullOrEmpty(Model.CurrentRoom.SpotifyAuthCode))
{
    <form method="get" asp-controller="Room" asp-action="AuthorizeSpotify" >
        <input type="hidden" asp-for="@Model.CurrentRoom.Id">
        <button class="btn btn-primary" type="submit" id="authorizeSpotifyButton">Authorize Spotify</button>
    </form>
}
else
{
    <label>Song: </label>
    <form method="post" asp-controller="Room" asp-action="AddSongToRoom" autocomplete="off" name="songSearchForm">
        <input hidden asp-for="@Model.SongToAdd" id="hiddenInput" />
        <ul class="select-list-group" id="slg">
            <li>
                <input type="text" class="select-list-group__search" placeholder="Song" id="songToAdd" name="songToAdd" />
                <span class="select-list-group__toggle"> </span>
                <ul class="select-list-group" data-toggle="false" id="songsList">
                </ul>
            </li>
        </ul>
    </form>

    <br />
    <br />
    <button class="btn btn-primary" type="submit" id="addSongButton">Add Song</button>

    <br />
    <br />
    <br />
    <button class="btn btn-primary" type="button" id="startPlaylistButton">Start Playlist</button>
}


@section Scripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            function postSongVote(songId) {
                $.ajax({
                    url: "/room/addvotetosong",
                    type: "POST",
                    data: {
                        "roomId": $("#roomId")[0].value,
                        "songId": songId
                    },
                    headers: {
                        'Authorization': "Bearer " + $("#jwtToken")[0].value,
                    },
                    success: function (data) {
                        $("#tableOfSongs").html(data);
                    },
                    error: function (data) {
                        console.log(data);
                    }
                });
            }

            $("[name='addVoteButton']").click(function () { postSongVote($(this).val()); })
        });
    </script>

    <script>
        function postSongData() {
            $.ajax({
                url: "/room/AddSongToRoom",
                type: "POST",
                data: {
                    "CurrentRoom.Id": $("#roomId")[0].value,
                    "CurrentRoom.SpotifyAuthCode": $("#spotifyAuthCode")[0].value,
                    "SongToAdd": $("#songToAdd")[0].value,
                },
                headers: {
                    'Authorization': "Bearer " + $("#jwtToken")[0].value,
                },
                success: function (data) {
                    $("#tableOfSongs").html(data);
                    $("#songToAdd").val('');
                },
                error: function (data) {
                    console.log(data);
                }
            });
        }

        
    </script>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        window.onSpotifyWebPlaybackSDKReady = () => {
            const token = $("#spotifyAuthCode").val();
            const player = new Spotify.Player({
                name: 'PartyPlaylist - ' + $("#roomNameHeader").html(),
                getOAuthToken: cb => { cb(token); }
            });

            // Error handling
            player.addListener('initialization_error', ({ message }) => { console.error(message); });
            player.addListener('authentication_error', ({ message }) => { console.error(message); });
            player.addListener('account_error', ({ message }) => { console.error(message); });
            player.addListener('playback_error', ({ message }) => { console.error(message); });

            // Playback status updates
            player.addListener('player_state_changed', state => { console.log(state); });

            // Ready
            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
            });

            // Not Ready
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });

            // Connect to the player!
            player.connect();

            $("#startPlaylistButton").click(function () {
                StartPlaylist(player, $("[name='playerUri']").first().html());
            });
        };
    </script>
    <script>
        function StartPlaylist(player, songUriToPlay) {
            const play = ({
                spotify_uri,
                playerInstance: {
                    _options: {
                        getOAuthToken,
                        id
                    }
                }
            }) => {
                getOAuthToken(access_token => {
                    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ uris: [spotify_uri] }),
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${access_token}`
                        },
                    });
                });
            };
            play({
                playerInstance: player,
                spotify_uri: songUriToPlay,
            });
        }
    </script>

    <script>
        var search = document.getElementById('songToAdd');
        var searchFunc = function () {
            var auth = $('#spotifyAuthCode').val();
            $.ajax({
                url: "/room/livesearch",
                type: "GET",
                async: true,
                data: {
                    "auth": auth,
                    "query": $('#songToAdd').val()
                },
                success: function (response) {

                    console.log(response);
                    if (response == null) {
                        return;
                    }
                    var formInput = document.getElementById('hiddenInput');
                    var searchedSongList = document.getElementById("songsList");

                    searchedSongList.innerHTML = response;
                    var liElements = searchedSongList.childNodes;
                    Array.prototype.forEach.call(liElements, s => s.addEventListener('click', function () {
                        formInput.value = s.id;
                        $.ajax({
                            url: "/room/AddSongToRoom",
                            type: "POST",
                            data: {
                                "CurrentRoom.Id": $("#roomId")[0].value,
                                "CurrentRoom.SpotifyAuthCode": $("#spotifyAuthCode")[0].value,
                                "SongToAdd": formInput.value,
                            },
                            headers: {
                                'Authorization': "Bearer " + $("#jwtToken")[0].value,
                            },
                            success: function (data) {
                                $("#tableOfSongs").html(data);
                            },
                            error: function (data) {
                                console.log(data);
                            }
                            });
                    }));

                    
                },
                error: function (response) {
                    console.log(response);
                }
            })
        }

        function submitInput (event) {

        }

        $(document).ready(function () {
            $('#songToAdd').on('input', debounce(searchFunc, 250));
            $('#songToAdd').keydown(function (e) {
                var firstLi = document.getElementById("songsList").firstElementChild;
                var formInput = document.getElementById('hiddenInput');
                if (e.keyCode == 13 && firstLi != null) {
                    formInput.value = firstLi.id;
                    $.ajax({
                        url: "/room/AddSongToRoom",
                        type: "POST",
                        data: {
                            "CurrentRoom.Id": $("#roomId")[0].value,
                            "CurrentRoom.SpotifyAuthCode": $("#spotifyAuthCode")[0].value,
                            "SongToAdd": formInput.value,
                        },
                        headers: {
                            'Authorization': "Bearer " + $("#jwtToken")[0].value,
                        },
                        success: function (data) {
                            $("#tableOfSongs").html(data);
                        },
                        error: function (data) {
                            console.log(data);
                        }
                    });
                }
            })
        })

        

        function debounce(func, wait, immediate) {
            var timeout;
            return function () {
                var context = this, args = arguments;
                var later = function () {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                var callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        };

        function deleteChildren(e) {

            var parent = document.getElementById(e);
            var children = parent.childNodes;
            console.log()
            for (let i = 0; i < children.length; i++) {
                console.log(children[i]);
            }

        }

    </script>
    <script src="~/js/roomhub.js"></script>
    <script src="~/js/selectList.js"></script>
}
